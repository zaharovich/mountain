# Store Locator - Поиск магазинов с геолокацией

## Описание проекта

Веб-приложение для поиска ближайших магазинов на интерактивной карте с фильтрацией по категориям товаров.

### Основные возможности:
- Определение геолокации пользователя (временно отключено для разработки - используется Полтава)
- Отображение магазинов на карте Leaflet
- **Умный поиск:** 10-15 магазинов в радиусе до 9 км, затем все в радиусе 20 км
- Использование координат ТОЛЬКО из поля `map` (без геокодирования)
- Фильтрация по категориям товаров
- Защита от парсинга (rate limiter по IP)
- Кеширование данных в localStorage
- Шифрование данных (Base64 + XOR) - временно отключено
- Адаптивный дизайн

---

## Быстрый старт

### 1. Установка зависимостей

```bash
npm install
```

Это установит:
- express
- cors
- dotenv

### 2. Запуск локального сервера

```bash
node server.js
```

Сервер запустится на `http://localhost:3000`

### 3. Открытие в браузере

Откройте в браузере:
```
http://localhost:3000
```

---

## Структура проекта

```
store-locator/
├── index.html              # Основной HTML файл
├── server.js               # Node.js сервер (Express)
├── package.json            # Зависимости проекта
├── generate-encrypted-data.js  # Скрипт генерации зашифрованных данных
├── assets/
│   └── tt.json            # Данные магазинов (JSON формат)
├── css/
│   └── styles.css         # Все стили (BEM методология)
└── js/
    ├── crypto.js          # Шифрование (Base64 + XOR)
    ├── dataManager.js     # Управление данными + кеширование
    ├── geolocation.js     # Геолокация, поиск магазинов, rate limiting
    ├── app.js             # Основная логика приложения
    └── test-data.js       # Тестовые данные
```

---

## Конфигурация

### Тестовая локация

В файле `js/app.js` установлена тестовая локация (Полтава, центр):

```javascript
const testLocation = {
    latitude: 49.5883,
    longitude: 34.5514,
    accuracy: 10
};
```

Чтобы включить реальную геолокацию, раскомментируйте код в методе `init()`.

### Данные магазинов

Файл `assets/tt.json` содержит данные в открытом виде (без шифрования) для разработки.

Структура данных:
```json
{
  "cities": [...],
  "shops": [
    {
      "id": "1380",
      "name": "Название магазина",
      "map": "https://www.google.com/maps/place/50.4265,30.5383",
      "products": [
        { "id": "130", "timestamp": "2025-11-10" }
      ]
    }
  ],
  "products": [
    { "id": "130", "title": "Горішки" }
  ]
}
```

---

## API Endpoints

### GET /api/tt.json
Возвращает данные магазинов

### POST /api/check-ip-location
Проверка IP Protection (rate limiting)

### POST /api/location-request
Запрос на добавление нового магазина (Telegram notification)

### GET /api/health
Проверка статуса сервера

---

## Разработка

### Изменение данных магазинов

1. Отредактируйте `assets/tt.json`
2. Перезагрузите страницу в браузере

### Генерация зашифрованных данных

```bash
node generate-encrypted-data.js
```

Это создаст файл `assets/tt.json` с зашифрованными данными.

### Очистка кеша

Откройте консоль браузера (F12) и выполните:
```javascript
localStorage.clear();
```

---

## Логика работы

### 1. Умный поиск магазинов

**Новая логика (2025-11-19):**

1. **Первичный поиск (0-9 км):**
   - Ищем 10-15 ближайших магазинов
   - Радиусы: 2км → 4км → 6км → 9км
   - Останавливаемся когда найдено ≥10 магазинов
   - Берем только первые 15 магазинов

2. **Если ничего не найдено в 9км:**
   - Показываем диалог "Оце халепа! Магазинів поблизу нема"
   - Кнопка "Шукати у більшому радіусі" → поиск в 20км
   - Кнопка "Хочу Вас Неподалік" → запрос на добавление

3. **Расширенный поиск (20км):**
   - Показываем ВСЕ магазины в радиусе 20км
   - Кнопка расширенного поиска скрывается
   - Если и в 20км ничего нет → диалог БЕЗ кнопки поиска

### 2. Координаты магазинов

- Используются ТОЛЬКО координаты из поля `map`
- Геокодирование адресов из названий **УДАЛЕНО**
- Фильтрация по городу пользователя **УДАЛЕНА**
- Показываются все магазины с валидными координатами

### 3. Фильтрация по свежести товаров

- < 2 недель - FRESH (яркие, зеленая полоса)
- > 2 недель, < 2 месяцев - STALE (тусклые, желтая полоса)
- > 2 месяцев - OLD (скрыто)

### 4. Rate Limiting

Защита от парсинга:
- Максимум 3 запроса с одного IP в радиусе 1 км за 24 часа
- Данные хранятся в памяти сервера

---

## Интеграция с WordPress

### Формат экспорта

В `dataManager.js` есть метод `exportForWordPress()` который экспортирует данные в формат для WordPress.

Пример использования:
```javascript
const wpData = dataManager.exportForWordPress();
console.log(wpData);
```

Формат данных оптимизирован для сохранения в WordPress custom post types или options.

---

## Технологии

- JavaScript (ES6+, модульная архитектура)
- HTML5
- CSS3 (BEM методология)
- Leaflet.js (карты)
- Node.js + Express (сервер)
- localStorage (кеширование)

---

## Важные заметки

### Текущее состояние:
- Шифрование ОТКЛЮЧЕНО (данные в открытом виде для отладки)
- Геолокация ОТКЛЮЧЕНА (используется тестовая локация Киев)
- Rate limiting работает в памяти сервера (при перезапуске сбрасывается)

### Перед продакшеном:
1. Включить реальную геолокацию в `js/app.js`
2. Включить шифрование данных в `js/dataManager.js`
3. Настроить rate limiting с сохранением в БД
4. Настроить Telegram уведомления в `server.js`

---

## Troubleshooting

### Карта не отображается
- Проверьте консоль браузера (F12)
- Убедитесь что Leaflet.js загружен
- Проверьте что контейнер карты имеет высоту

### Данные не загружаются
- Проверьте что сервер запущен
- Проверьте файл `assets/tt.json`
- Очистите кеш localStorage

### Магазины не отображаются
- Проверьте координаты в `assets/tt.json`
- Проверьте формат ссылок Google Maps
- Проверьте даты доставки товаров (должны быть актуальные)

---

## Контакты

Для вопросов по проекту обращайтесь к команде разработки.
